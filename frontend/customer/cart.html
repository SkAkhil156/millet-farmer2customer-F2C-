<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Millet Market — Cart & Orders</title>
  <link rel="stylesheet" href="customer.css">
  <style>
    /* small tweaks for orders area */
    .orders-wrap { margin-top: 22px; }
    .order-card { background:#fff;border-radius:12px;padding:12px;box-shadow:var(--shadow);margin-bottom:12px; }
    .order-meta { display:flex;justify-content:space-between;align-items:center;gap:12px }
    .order-items { margin-top:10px; border-top:1px dashed #e6efe4; padding-top:10px; display:none; }
    .order-items.open { display:block; }
    .small-muted { color:#6b7f6f;font-size:13px }
    .order-toggle { cursor:pointer; background:transparent;border:0;color:var(--green-2); font-weight:700; }
    .empty-note { padding:28px;text-align:center;color:#486a54;background:#fff;border-radius:12px;box-shadow:var(--shadow); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">MM</div>
        <div>
          <h1>Your Cart</h1>
          <div class="sub">Review items, change quantities, or place order</div>
        </div>
      </div>

      <div class="controls">
        <button class="ghost" id="backBtn">← Back to shop</button>
        <div style="width:1px"></div>
        <div class="pill" id="cartCountPill">0 items</div>
      </div>
    </header>

    <main style="margin-top:18px">
      <section id="cartContent">
        <!-- Cart content injected by JS -->
      </section>

      <section class="orders-wrap" id="ordersSection">
        <h3 style="margin:12px 0 8px 0">Orders</h3>
        <div id="ordersList">
          <!-- orders injected here -->
        </div>
      </section>
    </main>

    <footer></footer>
  </div>

<script>
/* cart.html JS - cart persisted in localStorage, orders persisted in sessionStorage
   Orders will survive navigation and reloads in the same tab, and will be cleared
   when the tab is closed. */

const CART_KEY = 'mm_cart_v1';
const ORDERS_KEY = 'mm_orders_v1_session'; // use sessionStorage for orders

// --- storage helpers for cart (localStorage) ---
function loadCart(){
  try{
    const raw = localStorage.getItem(CART_KEY);
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return parsed;
    return [];
  }catch(e){
    return [];
  }
}
function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

// --- storage helpers for orders (sessionStorage) ---
function loadOrders(){
  try{
    const raw = sessionStorage.getItem(ORDERS_KEY);
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return parsed;
    return [];
  }catch(e){
    return [];
  }
}
function saveOrders(orders){ sessionStorage.setItem(ORDERS_KEY, JSON.stringify(orders)); }

function formatRupee(v){ return '₹'+Number(v).toLocaleString('en-IN'); }
function formatDate(ts){
  const d = new Date(ts);
  const opts = { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' };
  return d.toLocaleString('en-IN', opts);
}

// --- STATE ---
let cart = loadCart();
let orders = loadOrders(); // load from sessionStorage

const cartContent = document.getElementById('cartContent');
const ordersList = document.getElementById('ordersList');
const cartCountPill = document.getElementById('cartCountPill');

function renderCartPage(){
  cartContent.innerHTML = '';
  if(!cart.length){
    cartContent.innerHTML = `<div class="empty-note">
      <h3>Your cart is empty</h3>
      <p>Browse products and add items to the cart. They'll appear here.</p>
      <div style="margin-top:18px">
        <button class="btn" id="shopBtn">Go to shop</button>
      </div>
    </div>`;
    document.getElementById('shopBtn')?.addEventListener('click', ()=>location.href='customer.html');
    updateSummary();
    return;
  }

  // items list
  const listWrap = document.createElement('div');
  listWrap.style.display = 'flex';
  listWrap.style.flexDirection = 'column';
  listWrap.style.gap = '12px';

  cart.forEach(item=>{
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '12px 0';
    row.innerHTML = `
      <div style="flex:1">
        <strong>${item.name}</strong>
        <div class='muted'>${item.provider} · ${formatRupee(item.price)}/${item.unit}</div>
      </div>
      <div style="text-align:right;min-width:190px">
        <div style="font-weight:800">${formatRupee(item.price * item.qty)}</div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px;align-items:center">
          <button class="ghost qty-btn" data-id="${item.id}" data-action="dec">-</button>
          <span style="padding:6px 10px">${item.qty}</span>
          <button class="btn qty-btn" data-id="${item.id}" data-action="inc">+</button>
        </div>
      </div>
    `;
    listWrap.appendChild(row);
  });

  cartContent.appendChild(listWrap);

  // summary block
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const summary = document.createElement('div');
  summary.style.marginTop = '18px';
  summary.style.display = 'flex';
  summary.style.justifyContent = 'space-between';
  summary.style.alignItems = 'center';
  summary.innerHTML = `
    <div><strong>Total:</strong> <span id="grandTotal">${formatRupee(total)}</span></div>
    <div style="display:flex;gap:8px">
      <button class="ghost" id="clearBtn">Clear</button>
      <button class="btn" id="placeOrderBtn">Place order</button>
    </div>
  `;
  cartContent.appendChild(summary);

  // wire qty buttons
  document.querySelectorAll('.qty-btn').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = Number(b.getAttribute('data-id'));
      const action = b.getAttribute('data-action');
      const it = cart.find(x=>x.id===id);
      if(!it) return;
      if(action==='inc') it.qty++;
      else { it.qty--; if(it.qty<=0) cart = cart.filter(x=>x.id!==id); }
      saveCart(cart);
      renderCartPage();
      // notify other tabs about cart change
      localStorage.setItem('mm_cart_updated_at', Date.now());
    });
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(confirm('Clear cart?')){ cart=[]; saveCart(cart); renderCartPage(); localStorage.setItem('mm_cart_updated_at', Date.now()); }
  });

  document.getElementById('placeOrderBtn').addEventListener('click', ()=>{
    if(!cart.length){ alert('Cart is empty'); return; }
    // build order
    const order = {
      id: 'ORD-' + Date.now(),
      createdAt: Date.now(),
      items: cart.map(i=>({ id:i.id, name:i.name, price:i.price, unit:i.unit, qty:i.qty, provider:i.provider })),
      total: cart.reduce((s,i)=>s+i.price*i.qty,0),
      status: 'Placed'
    };
    // store order in sessionStorage (persist across navigation in same tab)
    orders.unshift(order); // newest first
    saveOrders(orders);

    // clear cart (persisted)
    cart = [];
    saveCart(cart);

    // update UI
    renderCartPage();
    renderOrders();

    // notify other tabs about cart change
    localStorage.setItem('mm_cart_updated_at', Date.now());

    alert('Order placed — thank you! Order ID: ' + order.id + '\nTotal: ' + formatRupee(order.total));
  });

  updateSummary();
}

function renderOrders(){
  ordersList.innerHTML = '';
  if(!orders.length){
    ordersList.innerHTML = `<div class="empty-note">
      <h4>No past orders</h4>
      <p>Orders placed in this tab will appear here. They will be cleared when the tab is closed.</p>
    </div>`;
    return;
  }

  orders.forEach(order=>{
    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div class="order-meta">
        <div>
          <div><strong>Order ${order.id}</strong></div>
          <div class="small-muted">${formatDate(order.createdAt)} · ${order.items.length} item(s)</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800">${formatRupee(order.total)}</div>
          <div style="margin-top:8px">
            <button class="order-toggle" data-id="${order.id}">View items</button>
          </div>
        </div>
      </div>
      <div class="order-items" id="items-${order.id}">
        ${ order.items.map(it => `
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #eef6ec">
            <div>
              <strong>${it.name}</strong>
              <div class="muted">${it.provider} · ${formatRupee(it.price)}/${it.unit}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:800">${formatRupee(it.price * it.qty)}</div>
              <div style="margin-top:6px">${it.qty} ×</div>
            </div>
          </div>`).join('') }
        <div style="margin-top:10px" class="small-muted">Status: ${order.status}</div>
      </div>
    `;
    ordersList.appendChild(card);
  });

  // wire toggles
  document.querySelectorAll('.order-toggle').forEach(btn=>{
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const el = document.getElementById('items-' + id);
      if(!el) return;
      el.classList.toggle('open');
      btn.textContent = el.classList.contains('open') ? 'Hide items' : 'View items';
    });
  });
}

function updateSummary(){
  const count = cart.reduce((s,i)=>s+i.qty,0);
  cartCountPill.textContent = count + (count===1 ? ' item' : ' items');
}

// back button
document.getElementById('backBtn').addEventListener('click', ()=> location.href = 'customer.html');

// initial render
renderCartPage();
renderOrders();

// Keep cart in sync across tabs if cart changed elsewhere
window.addEventListener('storage', (e)=>{
  if(e.key === CART_KEY || e.key === 'mm_cart_updated_at'){
    cart = loadCart();
    renderCartPage();
  }
  // sessionStorage changes do not trigger 'storage' events across tabs,
  // and that's fine — orders are intended to be per-tab session.
});
</script>

</body>
</html>
